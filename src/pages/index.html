<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://glitch.com/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Hello Node!</title>

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css" />  
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="code.js"></script>
    <script src="data.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#"><strong>Tu viaje</strong></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link active" aria-current="page" href="#">Inicio</a>
            <a class="nav-link" href="/">Cliente</a>
            <a class="nav-link" href="servicio.html">Chofer</a>
           </div>
        </div>
      </div>
    </nav>
    <div class="container">
      <h1>
          Para Clientes
      </h1> 
      
      <div class="form-group">
        <label for nombrecliente>Nombre:</label>
        <input type="text" id="nombrecliente"  class="form-control" onchange="cambioNombre()">
      </div>
      <div class="form-group">
        <label for telcliente>Teléfono:</label>
        <input type="tel" id="telcliente"  class="form-control" onchange="cambioTel()">
      </div>
      <div class="form-group">
        <label for destino>Destino  :</label>
        <select id="destino" class="form-control" onchange="zonaSelected()">
          
        </select>
      </div>
      <button class="btn btn-success mt-2" onclick="buscar()" style="display:none;">Buscar transporte</button>
      <br>
      <!--<p id="pp"></p>-->
      <div id="oferta">
        Servicio disponible:
        <ul id="messages"></ul>
      </div>
      
    </div>
    <script>
      var socket = io();
      
      var messages = document.getElementById('messages');
      var nCliente = document.getElementById('nombrecliente')
      var tCliente = document.getElementById('telcliente')
      var misZonas = document.getElementById('destino');
      var losCarros = []; 
      //Verificar nombre guardado
      document.getElementById("nombrecliente").value = getCookie('nombrecliente')
      document.getElementById("telcliente").value = getCookie('telcliente')
      socket.emit('conectado',{'rol':'cliente','nombre':getCookie('nombrecliente'),
                              'telef':'getCookie('telcliente')})
      socket.on('carros', (listaDeCarros) =>{ 
        populateCarros(listaDeCarros);
      });
      
      //document.getElementById('pp').innerHTML=window.location.href
      
      function buscar(){
        nCliente = document.getElementById("nombrecliente");
        populateCarros(losCarros);
        document.getElementById("oferta").style.display = 'block';
        setCookie('nombrecliente', nCliente.value, 9000) //Guardar nombre del cliente
      }
      
      function cambioNombre(){
        nCliente = document.getElementById("nombrecliente");
        populateCarros(losCarros);
        document.getElementById("oferta").style.display = 'block';
        setCookie('nombrecliente', nCliente.value, 9000) //Guardar nombre del cliente
      }
      
      function cambioTel(){
        tCliente = document.getElementById('telcliente')
        populateCarros(losCarros);
        document.getElementById("oferta").style.display = 'block';
        setCookie('telcliente', tCliente.value, 9000) //Guardar teléfono del cliente x 1 año
      }
      
      function populateCarros(listaDeCarros){
        losCarros = listaDeCarros;
        messages.innerHTML=''
        console.log("La zona: ", laZona)
        for (var carro of listaDeCarros){
          var item = document.createElement('li'); 
          seleccion = document.createElement('a')
          seleccion.textContent = carro.nombre; 
          seleccion.setAttribute("href", "protocolo.html"+"?carro="+carro.nombre
                                +"&lat="+carro.lat+"&long="+carro.long
                                +"&cli="+nCliente.value+"&dest="+laZona
                                +"&tel="+tCliente.value);         
          item.appendChild(seleccion);
          messages.appendChild(item);    
        }  
        window.scrollTo(0, document.body.scrollHeight);         
      }
      
      function zonaSelected(){
        var idx = misZonas.selectedIndex; 
        laZona = misZonas.options[idx].value; 
        setCookie('zonacliente', laZona, 1) //Guardar el destino por 1 hora
        populateCarros(losCarros);
      }
      //Poblar lista de zonas
      for (var zona of zonas){
        var item = document.createElement('option');
        item.text=zona.nombre;
        item.value=zona.nombre;
        misZonas.appendChild(item);
      }
      
      var actualZona = getCookie('zonacliente');
      
      if (actualZona){
          var laZona = actualZona;
          misZonas.value = actualZona;
      } else {
          var laZona = misZonas.options[0].value;
      }
    </script>    
  </body>
</html>
